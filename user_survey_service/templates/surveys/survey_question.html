{% extends 'base.html' %}
{% block content %}
    <h2 align="center" style="color: navy;">Текущий Опрос: {{ survey.title }}</h2>
    {% if user.is_authenticated %}
        Привет, {{ user.username }}!
    {% else %}
        Пожалуйста, войдите.
    {% endif %}
    <div style="margin-left: 40px; margin-right: 40px; color: #333;">
        <form id="surveyForm" method="post" action="{% url 'surveys:survey_question' survey_slug=survey.slug question_slug=question.slug %}">
            {% csrf_token %}
            <input type="hidden" name="parent_answer_id" value="{{ parent_answer.id }}">
            <br>
            <h3>{{ question.title }}</h3>

            {% if question.choices.exists %}
                <!-- Радиокнопочки для выбора одного ответа из списка (предоставленный ответ) -->
                {% for choice in question.choices.all %}
                    <input type="radio" id="choice_{{ choice.id }}" name="question_{{ question.id }}" value="{{ choice.id }}" required>
                    <label for="choice_{{ choice.id }}">{{ choice.text }}</label><br>
                {% endfor %}
            {% else %}
                <!-- Если вопрос не имеет вариантов ответов, выводим текстовое поле -->
                <input type="text" name="question_{{ question.id }}" required>
            {% endif %}

            <button type="submit" id="submitFormBtn">Отправить выбранный ответ</button>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function () {
            // Добавляем обработчик события submit формы
            $("#surveyForm").submit(function (event) {
                // Отменяем стандартное поведение формы
                event.preventDefault();

                // Вызываем метод submit формы
                $(this).unbind('submit').submit();
            });

            // Добавляем обработчик для обработки JSON-ответа после успешной отправки формы
            $(document).ajaxComplete(function (event, xhr, settings) {
                var jsonResponse = JSON.parse(xhr.responseText);
                if (jsonResponse.redirect) {
                    // Используем window.location.href для перенаправления на новую страницу
                    window.location.href = jsonResponse.redirect;
                }
            });
        });
    </script>
{% endblock %}